# HabitFlow Backend Setup Guide

This guide will help you set up the HabitFlow Django backend with proper Python virtual environment isolation.

## Quick Start

1. **Run the setup script:**
   ```bash
   cd habitflow/backend
   ./setup_backend.sh
   ```

2. **Choose your database setup:**
   - **SQLite (Simple):** `./run_local_sqlite.sh`
   - **PostgreSQL + Redis (Recommended):** `./run_with_docker_db.sh`

## Prerequisites

- Python 3.11+
- Docker and Docker Compose (for PostgreSQL/Redis option)
- Git

## Setup Options

### Option 1: SQLite (Simple Development)

Best for: Quick setup, learning, or simple development

```bash
# 1. Setup backend
./setup_backend.sh

# 2. Run with SQLite
./run_local_sqlite.sh
```

### Option 2: PostgreSQL + Redis (Recommended)

Best for: Production-like development environment

```bash
# 1. Setup backend
./setup_backend.sh

# 2. Run with PostgreSQL and Redis via Docker
./run_with_docker_db.sh
```

### Option 3: Full Docker Setup

Best for: Consistent environment across team members

```bash
# From project root
cd habitflow
docker-compose up
```

## Project Structure

```
habitflow/backend/
├── setup_backend.sh           # Main setup script
├── run_local_sqlite.sh        # SQLite development server
├── run_with_docker_db.sh      # PostgreSQL + Redis development server
├── manage_db.sh               # Database management utilities
├── .env                       # Environment variables (created from .env.example)
├── venv/                      # Python virtual environment
├── core/                      # Django project settings
├── users/                     # User management app
├── habits/                    # Habit tracking app
├── forest/                    # Gamification/forest app
└── manage.py                  # Django management script
```

## Environment Configuration

The setup script automatically creates a `.env` file from `.env.example` with:

- **Django Secret Key:** Auto-generated secure key
- **JWT Secret Key:** Auto-generated for authentication
- **Database Settings:** Configured based on chosen setup
- **CORS Settings:** Configured for frontend development

## Database Management

Use the `manage_db.sh` script for database operations:

```bash
# Run migrations
./manage_db.sh migrate

# Create new migrations
./manage_db.sh makemigrations

# Create superuser
./manage_db.sh superuser

# Reset database (WARNING: destroys data)
./manage_db.sh reset

# Open Django shell
./manage_db.sh shell

# Load initial fixtures
./manage_db.sh fixtures

# PostgreSQL-specific operations
./manage_db.sh backup                    # Backup database
./manage_db.sh restore backup_file.sql   # Restore from backup
```

## Development Workflow

### Daily Development

1. **Activate virtual environment:**
   ```bash
   source venv/bin/activate
   ```

2. **Start development server:**
   ```bash
   # SQLite
   ./run_local_sqlite.sh
   
   # Or PostgreSQL
   ./run_with_docker_db.sh
   ```

### Adding New Dependencies

```bash
# Activate virtual environment
source venv/bin/activate

# Add dependency with Poetry
poetry add package_name

# For development dependencies
poetry add --group dev package_name
```

### Code Quality

```bash
# Format code
make format

# Lint code
make lint

# Run tests
make test
```

## API Documentation

Once the server is running, access:

- **API Docs:** http://localhost:8000/api/v1/docs/
- **Admin Interface:** http://localhost:8000/admin/
- **API Root:** http://localhost:8000/api/v1/

## Configuration Details

### Virtual Environment

- **Location:** `habitflow/backend/venv/`
- **Python Version:** 3.11+
- **Isolated:** All dependencies are contained within the workspace

### Database Configurations

#### SQLite Configuration
- **File:** `db.sqlite3`
- **Settings:** `core.settings.local`
- **Best for:** Simple development, testing

#### PostgreSQL Configuration
- **Host:** localhost:5432
- **Database:** habitflow
- **User:** postgres
- **Password:** postgres
- **Settings:** `core.settings.postgres`
- **Best for:** Production-like development

### Environment Variables

Key environment variables in `.env`:

```bash
# Django
DJANGO_SETTINGS_MODULE=core.settings.local
DEBUG=True
DJANGO_SECRET_KEY=<auto-generated>

# Database (PostgreSQL)
DB_ENGINE=django.db.backends.postgresql
DB_NAME=habitflow
DB_USER=postgres
DB_PASSWORD=postgres
DB_HOST=localhost
DB_PORT=5432

# Redis
REDIS_URL=redis://localhost:6379/0

# JWT
JWT_SECRET_KEY=<auto-generated>

# CORS
ALLOWED_HOSTS=localhost,127.0.0.1
CORS_ALLOWED_ORIGINS=http://localhost:3000,http://localhost:5173
```

## Troubleshooting

### Common Issues

1. **Poetry not found after setup:**
   ```bash
   source venv/bin/activate
   pip install poetry
   ```

2. **Database connection errors:**
   - For PostgreSQL: Ensure Docker containers are running
   - Check `docker-compose ps`
   - Restart containers: `docker-compose restart db redis`

3. **Migration errors:**
   ```bash
   ./manage_db.sh reset  # WARNING: destroys data
   ./manage_db.sh migrate
   ```

4. **Permission denied on scripts:**
   ```bash
   chmod +x *.sh
   ```

### Docker Issues

```bash
# Check container status
docker-compose ps

# View logs
docker-compose logs db
docker-compose logs redis

# Restart services
docker-compose restart

# Clean restart
docker-compose down
docker-compose up -d db redis
```

## Production Notes

- **Security:** Update secret keys for production
- **Database:** Use managed PostgreSQL service
- **Environment:** Use `core.settings.production`
- **Static Files:** Configure proper static file serving
- **CORS:** Restrict to specific domains

## Next Steps

After setup:

1. **Create superuser account**
2. **Explore the admin interface**
3. **Check API documentation**
4. **Run tests:** `make test`
5. **Set up frontend** (see frontend README)

## Support

- **Documentation:** `/docs/API_USAGE.md`
- **Issues:** Check GitHub issues
- **Code Quality:** Use pre-commit hooks